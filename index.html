<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>GA 3D Viewer</title>
  <style>
    :root { color-scheme: dark; }
    html, body { height:100%; margin:0; background:#0e0f13; color:#e6e6e6; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    model-viewer { width:100%; height:100%; display:block; }

    /* Loading overlay (logo + spinner) */
    #overlay {
      position:fixed; inset:0; display:flex; flex-direction:column;
      align-items:center; justify-content:center; gap:18px;
      background: radial-gradient(1000px 700px at 50% 40%, rgba(255,255,255,0.06), rgba(0,0,0,0.85));
      z-index:10; padding:20px; box-sizing:border-box; text-align:center;
    }
    #brand img { max-width:70vw; width:520px; height:auto; display:block; filter: drop-shadow(0 6px 22px rgba(0,0,0,.45)); }
    .spinner { width:46px; height:46px; border-radius:50%; border:3px solid rgba(255,255,255,0.2); border-top-color:#fff; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .btn { display:none; } /* no extra buttons */
  </style>

  <!-- Pin model-viewer + CDN fallback -->
  <script type="module" src="https://unpkg.com/@google/model-viewer@3.3.0/dist/model-viewer.min.js"></script>
  <script type="module" onerror="
    var s=document.createElement('script');
    s.type='module';
    s.src='https://cdn.jsdelivr.net/npm/@google/model-viewer@3.3.0/dist/model-viewer.min.js';
    document.head.appendChild(s);
  "></script>
</head>
<body>
  <!-- Loading overlay -->
  <div id="overlay" role="status" aria-live="polite">
    <div id="brand"><img src="./logo.png" alt="Golden Art" /></div>
    <div class="spinner" aria-hidden="true"></div>
  </div>

  <model-viewer id="mv"
    camera-controls
    camera-target="auto"
    touch-action="none"
    interaction-prompt="none"
    exposure="1"
    shadow-intensity="0"
    environment-image="neutral"
    reveal="auto"
    loading="eager"
    alt="3D model">
  </model-viewer>

  <script>
    // Choose model from ?model=... else default to your T3_TIP1.glb
    const p = new URLSearchParams(location.search);
    const baseUrl = p.get('model') || './models/T3_TIP1.glb';

    const mv = document.getElementById('mv');
    const overlay = document.getElementById('overlay');

    // First try
    mv.src = baseUrl;

    // Watchdog: if no 'load' within 10s, retry once with cache-bust
    let loaded = false, retried = false;
    const watchdog = setTimeout(() => {
      if (!loaded && !retried) {
        retried = true;
        const bust = baseUrl + (baseUrl.includes('?') ? '&' : '?') + 'v=' + Date.now();
        mv.src = '';              // force cancel
        setTimeout(() => { mv.src = bust; }, 0);
      }
    }, 10000);

    // Hide overlay on success, and gently push camera BACK without changing angle
    mv.addEventListener('load', () => {
      loaded = true;
      clearTimeout(watchdog);
      overlay.style.display = 'none';

      // Keep the chosen angle; only increase distance
      try {
        const orbit = mv.getCameraOrbit();            // {theta, phi, radius}
        const R = Math.max(orbit.radius || 1, 1) * 3; // farther start; tweak 2..5 to taste
        mv.cameraOrbit = `${orbit.theta}rad ${orbit.phi}rad ${R}m`;

        const d = mv.idealCameraDistance || R;
        mv.minCameraOrbit = `auto auto ${Math.max(0.2, d * 0.35)}m`;
        mv.maxCameraOrbit = `auto auto ${d * 8}m`;
        mv.minFieldOfView = '18deg';
        mv.maxFieldOfView = '65deg';
      } catch (e) {
        // if getCameraOrbit not ready, ignore â€“ defaults are still fine
      }
    });

    // If the component emits 'error', do a single cache-bust retry if we haven't yet
    mv.addEventListener('error', () => {
      if (!retried) {
        retried = true;
        const bust = baseUrl + (baseUrl.includes('?') ? '&' : '?') + 'v=' + Date.now();
        mv.src = ''; setTimeout(() => { mv.src = bust; }, 0);
      }
      // Keep overlay visible so user sees the logo while retry occurs
    });
  </script>
</body>
</html>
