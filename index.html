<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>GA 3D Viewer</title>
  <style>
    :root { color-scheme: dark; }
    html, body { height:100%; margin:0; background:#0e0f13; color:#e6e6e6; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    #app { position:fixed; inset:0; }
    canvas { display:block; width:100%; height:100%; touch-action:none; }
    #gate, #overlay {
      position:fixed; inset:0; display:flex; flex-direction:column;
      align-items:center; justify-content:center; gap:18px;
      background: radial-gradient(1000px 700px at 50% 40%, rgba(255,255,255,0.06), rgba(0,0,0,0.85));
      z-index:10; padding:20px; box-sizing:border-box; text-align:center;
    }
    #gate { z-index: 11; }
    #brand img { max-width:70vw; width:520px; height:auto; display:block; filter: drop-shadow(0 6px 22px rgba(0,0,0,.45)); }
    .spinner { width:46px; height:46px; border-radius:50%; border:3px solid rgba(255,255,255,0.2); border-top-color:#fff; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .btn { padding:10px 16px; border-radius:12px; border:1px solid rgba(255,255,255,0.25); background: rgba(255,255,255,0.08); color:#fff; cursor:pointer; }
  </style>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';
    import { DRACOLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/DRACOLoader.js';

    const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

    const qs = new URLSearchParams(location.search);
    const modelUrl = qs.get('model') || './models/T3_TIP1.glb';

    const app = document.getElementById('app');
    const gate = document.getElementById('gate');
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('start');
    const retryBtn = document.getElementById('retry');

    // Scene
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0e0f13);

    const camera = new THREE.PerspectiveCamera(60, innerWidth / innerHeight, 0.01, 2000);
    camera.position.set(2.4, 1.6, 3.2);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, powerPreference: 'low-power' });
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.setPixelRatio(isiOS ? 1 : Math.min(devicePixelRatio, 2));
    renderer.setSize(innerWidth, innerHeight);
    app.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.06;

    scene.add(new THREE.HemisphereLight(0xffffff, 0x222244, 0.9));
    const dir = new THREE.DirectionalLight(0xffffff, 0.9); dir.position.set(6, 10, 8); scene.add(dir);

    const loader = new GLTFLoader();
    const draco = new DRACOLoader(); draco.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/'); loader.setDRACOLoader(draco);
    loader.setCrossOrigin('anonymous');

    function fitCamera(object, offset = 1.4) {
      const box = new THREE.Box3().setFromObject(object);
      const size = new THREE.Vector3(), center = new THREE.Vector3();
      box.getSize(size); box.getCenter(center);
      const maxDim = Math.max(size.x, size.y, size.z) || 1.0;
      const fov = camera.fov * (Math.PI / 180);
      const dist = Math.abs(maxDim / (2 * Math.tan(fov / 2))) * offset;
      camera.position.set(center.x + dist * 0.6, center.y + dist * 0.45, center.z + dist);
      controls.target.copy(center);
      controls.update();
    }

    let root = null;
    async function loadModel() {
      overlay.style.display = 'flex';
      try {
        const gltf = await loader.loadAsync(modelUrl);
        if (root) scene.remove(root);
        root = gltf.scene || gltf.scenes[0];
        root.traverse(o => { if (o.isMesh) { o.castShadow = false; o.receiveShadow = false; } });
        scene.add(root);
        fitCamera(root, 1.4);
        overlay.style.display = 'none';
      } catch (e) {
        console.error(e);
        overlay.style.display = 'flex';
      }
    }

    function animate() {
      controls.update();
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }
    animate();

    addEventListener('resize', () => {
      camera.aspect = innerWidth / innerHeight; camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });

    if (isiOS) { gate.style.display = 'flex'; startBtn.addEventListener('click', () => { gate.style.display = 'none'; loadModel(); }); }
    else { gate.style.display = 'none'; loadModel(); }

    retryBtn.addEventListener('click', () => loadModel());
  </script>
</head>
<body>
  <div id="app"></div>

  <!-- Tap-to-load gate (iPhone) -->
  <div id="gate" style="display:none">
    <div id="brand"><img src="data:image/png;base64,{{PUT_BASE64_HERE}}" alt="Golden Art" /></div>
    <button id="start" class="btn">Tap to load 3D</button>
  </div>

  <!-- Loading overlay (logo + spinner only) -->
  <div id="overlay" style="display:none">
    <div id="brand"><img src="data:image/png;base64,{{PUT_BASE64_HERE}}" alt="Golden Art" /></div>
    <div class="spinner" aria-hidden="true"></div>
    <button id="retry" class="btn">Retry</button>
  </div>
</body>
</html>
